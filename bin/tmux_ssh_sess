#!/bin/bash

#set -x

## if we are inside tmux dettach first
#if [ -n "$TMUX" ]
#then
#    tmux detach
#fi

if [ -n "$1" ]
then
    host=$1
    echo "$host" > ~/.ts_sess
else
    echo "host argument ('$1') is empty"
    echo "using last argument"
    host="$(cat ~/.ts_sess)"
    #exit 2
fi

if [ -n "$2" ]
then
    target_screen="$2"
else
    target_screen='s'
fi


# create a new detached session if it does not exist.
if ! tmux has-session -t=$host
then
    tmux_temp="$TMUX"
    unset TMUX
    tmux new-session -d -s $host
    export TMUX=$tmux_temp
    tmux switch-client -t $host
    exit
elif ! ( tmux ls | grep -q -E "$host.*attached" )
then
    tmux switch-client -t $host
elif tmux ls | grep -q -E "$host.*attached"
then
    tmux rename-window $target_screen
    tmux select-pane -t 0
    tmux send-keys "if ! [[ "$HOSTNAME" =~ "$host" ]]; then ssh $host; fi" C-m
    tmux send-keys "screen -rd ${target_screen}1 || screen -S ${target_screen}1" C-m
    tmux select-pane -t 1 || ( tmux split-window -h )
    tmux send-keys "if ! [[ "$HOSTNAME" =~ "$host" ]]; then ssh $host; fi" C-m
    tmux send-keys "screen -rd ${target_screen}2 || screen -S ${target_screen}2" C-m
fi

